/*! owncloud-chat 2014-11-29 */
function tran(id,vars){var text=$("#"+id).text(),_build=function(text,vars){return text.replace(/{([^{}]*)}/g,function(a,b){var r=vars[b];return"string"==typeof r||"number"==typeof r?r:a})};return _build(text,vars)}angular.module("chat",["ngSanitize","bernhardposselt.enhancetext"]),angular.module("chat").config(["enhanceTextFilterProvider","$httpProvider",function(enhanceTextFilterProvider,$httpProvider){enhanceTextFilterProvider.setOptions({embeddedImagesHeight:"150px"}),$httpProvider.defaults.headers.common.requesttoken=oc_requesttoken,emojione.sprites=!0,emojione.ascii=!0}]),angular.module("chat").factory("och",["convs","contacts","session","initvar",function(convs,contacts,$session,initvar){var api={command:{attachFile:function(convId,paths,user){api.util.doRequest({type:"command::attach_file::request",data:{conv_id:convId,timestamp:Time.now(),user:user,session_id:$session.id,paths:paths}},function(){})},removeFile:function(convId,path){api.util.doRequest({type:"command::remove_file::request",data:{conv_id:convId,timestamp:Time.now(),user:$session.user,session_id:$session.id,path:path}},function(){})},join:function(convId,success){api.util.doRequest({type:"command::join::request",data:{conv_id:convId,timestamp:Time.now(),user:$session.user,session_id:$session.id}},success)},invite:function(userToInvite,convId,success){api.util.doRequest({type:"command::invite::request",data:{conv_id:convId,timestamp:Time.now(),user_to_invite:userToInvite,user:$session.user,session_id:$session.id}},success)},sendChatMsg:function(msg,convId,success){api.util.doRequest({type:"command::send_chat_msg::request",data:{conv_id:convId,chat_msg:msg,user:$session.user,session_id:$session.id,timestamp:Time.now()}},success)},online:function(){api.util.doRequest({type:"command::online::request",data:{user:$session.user,session_id:$session.id,timestamp:Time.now()}},function(){})},offline:function(){api.util.doSyncRequest({type:"command::offline::request",data:{user:$session.user,session_id:$session.id,timestamp:Time.now()}},function(){})},startConv:function(userToInvite,success){api.util.doRequest({type:"command::start_conv::request",data:{user:$session.user,session_id:$session.id,timestamp:Time.now(),user_to_invite:userToInvite}},success)},getMessages:function(convId,startpoint,success){api.util.doRequest({type:"data::messages::request",data:{user:$session.user,session_id:$session.id,conv_id:convId,startpoint:startpoint}},success)},getUsers:function(convId,success){api.util.doRequest({type:"data::get_users::request",data:{user:$session.user,session_id:$session.id,conv_id:convId}},success)}},on:{invite:function(data){var backend=Chat.app.view.getBackends("och"),convId=data.conv_id;void 0===convs.get(convId)&&api.command.join(data.conv_id,function(dataJoin){var users=dataJoin.data.users,msgs=dataJoin.data.messages;convs.addConv(convId,users,backend,msgs)})},chatMessage:function(data){convs.addChatMsg(data.conv_id,data.user,data.chat_msg,data.timestamp,"och")},joined:function(data){convs.replaceUsers(data.conv_id,data.users)},online:function(data){contacts.markOnline(data.user.id)},offline:function(data){contacts.markOffline(data.user.id)},fileAttached:function(data){convs.attachFile(data.conv_id,data.path,data.timestamp,data.user)},fileRemoved:function(data){convs.removeFile(data.conv_id,data.path,data.timestamp,data.user)}},util:{doRequest:function(request,success){$.ajax({type:"POST",url:OC.generateUrl("/apps/chat/och/api"),data:JSON.stringify(request),headers:{"Content-Type":"application/json"}}).always(function(data){success(data)})},doSyncRequest:function(request){$.ajax({type:"POST",url:OC.generateUrl("/apps/chat/och/api"),data:JSON.stringify(request),headers:{"Content-Type":"application/json"},async:!0})},longPoll:function(){api.util.getPushMessages(function(data){var ids_del=[];for(var push_id in data.push_msgs){var push_msg=data.push_msgs[push_id];ids_del.push(push_id),api.util.handlePushMessage(push_msg)}api.util.deletePushMessages(ids_del,function(){api.util.longPoll()})})},handlePushMessage:function(push_msg){"invite"===push_msg.type?api.on.invite(push_msg.data):"send_chat_msg"===push_msg.type?api.on.chatMessage(push_msg.data):"joined"===push_msg.type?api.on.joined(push_msg.data):"online"===push_msg.type?api.on.online(push_msg.data):"offline"===push_msg.type?api.on.offline(push_msg.data):"file_attached"===push_msg.type?api.on.fileAttached(push_msg.data):"file_removed"===push_msg.type&&api.on.fileRemoved(push_msg.data)},getPushMessages:function(success){api.util.doRequest({type:"push::get::request",data:{user:$session.user,session_id:$session.id}},success)},deletePushMessages:function(ids,success){api.util.doRequest({type:"push::delete::request",data:{user:$session.user,session_id:$session.id,ids:ids}},function(){success()})}},INVALID_HTTP_TYPE:0,COMMAND_NOT_FOUND:1,PUSH_ACTION_NOT_FOUND:2,DATA_ACTION_NOT_FOUND:3,NO_SESSION_ID:6,USER_NOT_EQUAL_TO_OC_USER:7,NO_TIMESTAMP:8,NO_CONV_ID:9,NO_USER_TO_INVITE:10,USER_EQUAL_TO_USER_TO_INVITE:11,USER_TO_INVITE_NOT_OC_USER:12,NO_CHAT_MSG:13};return{init:function(){api.util.longPoll(),setInterval(api.command.online,6e3),initvar.backends.och.connected=!0},quit:function(){api.command.offline()},sendChatMsg:function(convId,msg){api.command.sendChatMsg(msg,convId,function(){})},invite:function(convId,userToInvite,groupConv,callback){if(groupConv)api.command.invite(userToInvite,convId,callback);else{var users=[];for(var key in convs.get(convId).users)users.push(convs.get(convId).users[key]);users.push(userToInvite),this.newConv(users,callback)}},newConv:function(userToInvite,success){api.command.startConv(userToInvite,success)},attachFile:function(convId,paths,user){api.command.attachFile(convId,paths,user)},removeFile:function(convId,path){api.command.removeFile(convId,path)},configChanged:function(){}}}]),angular.module("chat").factory("xmpp",["convs","contacts","initvar","session","authorize",function(convs,contacts,initvar,$session,authorize){$XMPP={on:{chatMessage:function(msg,from){var convId=from.substring(0,from.indexOf("/"));convs.addChatMsg(convId,contacts.findByBackendValue("xmpp",convId),msg,Time.now(),"xmpp")},connected:function(){},disconnected:function(){}},jid:initvar.backends.xmpp.config.jid,password:initvar.backends.xmpp.config.password,bosh_url:initvar.backends.xmpp.config.bosh_url,conn:null,_onMessage:function(msg){var from=(msg.getAttribute("to"),msg.getAttribute("from")),type=msg.getAttribute("type"),elems=msg.getElementsByTagName("body");if("chat"==type&&elems.length>0){var body=elems[0],convId=Strophe.getBareJidFromJid(from);if(!convs.exists(convId)){var contact={id:convId,online:!1,displayname:convId,order:0,backends:[{id:"xmpp",displayname:"XMPP",protocol:"xmpp",namespace:"xmpp",value:convId}],address_book_id:"local",address_book_backend:"0",saved:!1};contacts.contacts[convId]=contact,convs.addConv(convId,[contact,contacts.self()],"xmpp",[],[])}$XMPP.on.chatMessage(Strophe.getText(body),from)}return!0},_onConnect:function(status){if(status==Strophe.Status.CONNECTING)log("Strophe is connecting.");else if(status==Strophe.Status.CONNFAIL)log("Strophe failed to connect."),initvar.backends.xmpp.connected=!1;else if(status==Strophe.Status.DISCONNECTING)log("Strophe is disconnecting."),initvar.backends.xmpp.connected=!1;else if(status==Strophe.Status.DISCONNECTED)log("Strophe is disconnected."),initvar.backends.xmpp.connected=!1;else if(status==Strophe.Status.CONNECTED){log("Strophe is connected."),initvar.backends.xmpp.connected=!0,$XMPP.con.addHandler($XMPP._onMessage,null,"message",null,null,null);var iq=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});$XMPP.con.addHandler($XMPP._processRoster,"jabber:iq:roster","iq"),$XMPP.con.send(iq),$XMPP.con.addHandler($XMPP.onPresence,null,"presence"),$XMPP.con.send($pres()),$XMPP._generateConvs()}else status==Strophe.Status.AUTHFAIL&&alert("auth fail")},_processRoster:function(iq){var contactsToAdd=[];return $(iq).find("item").each(function(){var jid=$(this).attr("jid");console.log("found item in roster with jid "+jid);var bareJid=Strophe.getBareJidFromJid(jid),name=$(this).attr("name")||jid,subscription=$(this).attr("subscription");-1===$XMPP.roster.indexOf(bareJid)&&"remove"!==subscription&&$XMPP.roster.push(bareJid);var contact=contacts.findByBackendValue("xmpp",bareJid);if(!contact&&"remove"!==subscription){var oContact={FN:name,IMPP:bareJid};-1===contactsToAdd.indexOf(oContact)&&contactsToAdd.push(oContact)}}),contactsToAdd.length>0&&contacts.addContacts(contactsToAdd,function(){$XMPP._generateConvs()}),!0},_generateConvs:function(){var XMPPContacts=contacts.findByBackend("xmpp");for(var key in XMPPContacts){var XMPPContact=XMPPContacts[key];for(var backendKey in XMPPContact.backends){var backend=XMPPContact.backends[backendKey];"xmpp"===backend.id&&convs.addConv(backend.value,[XMPPContact,contacts.self()],"xmpp",[],[])}}},onRaw:function(data){console.log(data)},onPresence:function(iq){var presenceType=$(iq).attr("type"),from=$(iq).attr("from"),bareJid=Strophe.getBareJidFromJid(from),contact=contacts.findByBackendValue("xmpp",bareJid),user=Strophe.getNodeFromJid(from);if(contact===!1&&user===$session.user.id)return!0;if("subscribe"===presenceType)authorize.jid=bareJid,authorize.name=contact.displayname,authorize.approve=function(){$XMPP.con.send($pres({to:authorize.jid,type:"subscribed"})),$XMPP.con.send($pres({to:authorize.jid,type:"subscribe"})),authorize.show=!1,authorize.jid=null,authorize.name=null},authorize.deny=function(){$XMPP.con.send($pres({to:authorize.jid,type:"unsubscribed"})),authorize.show=!1,authorize.jid=null,authorize.name=null},authorize.show=!0;else if("error"!==presenceType)if("unavailable"===presenceType)contacts.markOffline(contact.id);else{var show=$(iq).find("show").text();""===show||"chat"===show?contacts.markOnline(contact.id):contacts.markOffline(contact.id)}return!0},roster:[]};var log=function(msg){console.log(msg)};return Strophe.log=function(){},{init:function(){if(initvar.backends.xmpp.configErrors=[],null!==$XMPP.jid&&""!==$XMPP.jid&&"undefined"!=typeof $XMPP.jid&&null!==$XMPP.password&&""!==$XMPP.password&&"undefined"!=typeof $XMPP.password&&null!==$XMPP.bosh_url&&""!==$XMPP.bosh_url&&"undefined"!=typeof $XMPP.bosh_url)try{$XMPP.con=new Strophe.Connection($XMPP.bosh_url),$XMPP.con.connect($XMPP.jid,$XMPP.password,$XMPP._onConnect),$XMPP.con.rawInput=$XMPP.onRaw,$XMPP.con.rawOutput=$XMPP.onRaw}catch(e){"TypeError"===e.name&&"service is undefined"===e.message&&initvar.backends.xmpp.configErrors.push("Service is undefined"),console.log(e.name),console.log(e.message)}else initvar.backends.xmpp.configErrors.push("Fill in all the fields")},quit:function(){},sendChatMsg:function(convId,msg){var reply=$msg({to:convId,from:$XMPP.jid,type:"chat"}).c("body",null,msg);$XMPP.con.send(reply.tree())},invite:function(){},newConv:function(){},attachFile:function(){},removeFile:function(){},configChanged:function(){$XMPP.jid=initvar.backends.xmpp.config.jid,$XMPP.password=initvar.backends.xmpp.config.password,$XMPP.bosh_url=initvar.backends.xmpp.config.bosh_url,"undefined"!=typeof $XMPP.con&&null!==$XMPP.con&&$XMPP.con.disconnect(),this.init()},addContactToRoster:function(backendValue){var bareJid=Strophe.getBareJidFromJid(backendValue),contact=contacts.findByBackendValue("xmpp",bareJid),name=contact.displayname,iq=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:bareJid,name:name});$XMPP.con.sendIQ(iq);var subscribe=$pres({to:bareJid,type:"subscribe"});$XMPP.con.send(subscribe)},removeContactFromRoster:function(backendValue){var iq=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:backendValue,subscription:"remove"});$XMPP.con.sendIQ(iq);var index=$XMPP.roster.indexOf(backendValue);delete $XMPP.roster[index]},contactInRoster:function(id){return-1===$XMPP.roster.indexOf(id)?!1:!0}}}]),window.Chat=window.Chat||{},Chat.app=Chat.app||{},Chat.app.util={timeStampToDate:function(timestamp){{var date=new Date(1e3*timestamp);date.getHours(),(date.getMinutes()<10?"0":"")+date.getMinutes(),date.getSeconds()}return{hours:date.getHours(),minutes:(date.getMinutes()<10?"0":"")+date.getMinutes(),seconds:date.getSeconds()}},isYoutubeUrl:function(url){return url.indexOf("https://youtube.com")>-1||url.indexOf("https://youtube.com")>-1||url.indexOf("https://www.youtube.com")>-1||url.indexOf("http://www.youtube.com")>-1||url.indexOf("http://youtu.be")>-1?!0:!1},isImageUrl:function(url){var imgRegex=/((?:https?):\/\/\S*\.(?:gif|jpg|jpeg|tiff|png|svg|webp))/gi;return imgRegex.test(url)}},angular.module("chat").controller("ConvController",["$scope","$http","$filter","$interval","initvar","convs","contacts","backends","title","session",function($scope,$http,$filter,$interval,initvar,convs,contacts,backends,title,$session){function init(){for(var key in backends)backends[key].handle.init();$scope.initDone=!0;for(var backendId in $scope.initConvs)for(var key in $scope.initConvs[backendId]){var conv=$scope.initConvs[backendId][key],contactsInConv=[];for(var key in conv.users){var user=conv.users[key];contactsInConv.push(contacts.contacts[user])}convs.addConv(conv.id,contactsInConv,backends[backendId],[],conv.files);for(var key in conv.messages){var msg=conv.messages[key];convs.addChatMsg(conv.id,contacts.contacts[msg.user],msg.msg,msg.timestamp,backends[backendId],!0)}for(var key in conv.files){var file=conv.files[key];convs.addChatMsg(conv.id,file.user,tran("translations-attached",{displayname:file.user.displayname,path:file.path}),file.timestamp,backendId)}}$scope.makeFirstConvActive(),$scope.$session=$session}$(window).unload(function(){$scope.quit()}),Chat.scope=$scope,$(document).ready(function(){$scope.emojis=$filter("toEmojiArray")(emojione.emojioneList)}),$scope.view={elements:{chat:!1,initDone:!1,settings:!1,emojiContainer:!1,invite:!1,files:!1},inviteClick:function(){$scope.view.toggle("invite"),setTimeout(function(){$("#invite-search-field").focus()},1)},showEmojiPopover:function(){var height=$("#chat-window-footer").height();$scope.view.toggle("emojiContainer"),setTimeout(function(){$("#emoji-container").css("bottom",height+20)},1)},showFilePicker:function(){OCdialogs.filepicker("Please choose a file to attach to the conversation",function(paths){for(var key in paths){var path=paths[key];convs.attachFile($session.conv,path,Time.now(),$session.user)}var backend=$scope.convs[$session.conv].backend.id;backends[backend].handle.attachFile($session.conv,paths,$session.user)},!0)},showFiles:function(){$scope.view.toggle("files")},show:function(element,$event,exception){if(void 0!==$event){var classList=$event.target.classList;if(classList.contains(exception))return}$scope.view.elements[element]=!0},hide:function(element,$event,exceptions){if(void 0!==$event)for(var classList=$event.target.classList,i=0;i<exceptions.length;i++)if(classList.contains(exceptions[i]))return;$scope.view.elements[element]=!1},toggle:function(element){$scope.view.elements[element]=!$scope.view.elements[element]},makeActive:function(convId,$event,exception){$scope.view.hide("emptyMsg"),$scope.view.show("chat",$event,exception),$session.conv=convId,$scope.view.focusMsgInput(),convs.get(convId).new_msg=!1,$("#chat-msg-input-field").autosize({callback:function(){var height=$("#chat-msg-input-field").height();height+=15,$("#chat-window-footer").height(height),$("#chat-window-body").css("bottom",height),$("#chat-window-msgs").scrollTop($("#chat-window-msgs")[0].scrollHeight);var height=$("#chat-window-footer").height();$("#emoji-container").css("bottom",height+20)}})},unActive:function(){$session.conv=null},focusMsgInput:function(){$("#chat-msg-input-field")},unShare:function(convId,path,timestamp,user,key){var backend=$scope.convs[convId].backend.id;backends[backend].handle.removeFile(convId,path),convs.removeFile(convId,path,timestamp,user,key)},downloadFile:function(path){var dir="/",files=path;OC.redirect(OC.generateUrl("/apps/files/ajax/download.php?dir={dir}&files={files}",{dir:dir,files:files}))},addContactToRoster:function(convId){backends.xmpp.handle.addContactToRoster(convId)},removeContactFromRoster:function(convId){backends.xmpp.handle.removeContactFromRoster(convId)},saveContact:function(contactId){var contact=contacts.contacts[contactId];contacts.addContacts([{FN:contact.displayname,IMPP:contact.id}],function(){delete contacts.contacts[contactId]})}},$scope.sendChatMsg=function(){if(""!==$scope.fields.chatMsg&&null!==$scope.fields.chatMsg){var backend=convs.get($session.conv).backend.id;convs.addChatMsg($session.conv,$session.user,$scope.fields.chatMsg,Time.now(),backend),backends[backend].handle.sendChatMsg($session.conv,$scope.fields.chatMsg),$scope.fields.chatMsg="",setTimeout(function(){$("#chat-msg-input-field").trigger("autosize.resize")},1),$("#chat-msg-input-field").focus();for(var key in convs.get($session.conv).users){var user=convs.get($session.conv).users[key];if(user.id!==$session.user.id){var order=contacts.getHighestOrder();contacts.contacts[user.id].order=order}}}},$scope.convs=convs.convs,$scope.contacts=contacts.contacts,$scope.backends=backends,$scope.initConvs={},$scope.isWindowActive=!0,$scope.fields={chatMsg:""},$session.user=contacts.contacts[OC.currentUser],$session.id=initvar.sessionId,$scope.initConvs=initvar.initConvs,$scope.initvar=initvar,$scope.quit=function(){for(var id in backends)backends[id].handle.quit()},$scope.makeFirstConvActive=function(){firstConv=convs.getFirstConv(),void 0===firstConv?($session.conv=null,$scope.view.hide("chat"),$scope.view.show("emptyMsg")):$scope.view.makeActive(firstConv)},$scope.invite=function(userToInvite){var backend=$scope.convs[$session.conv].backend.id,groupConv=$scope.convs[$session.conv].users.length>2;backends[backend].handle.invite($session.conv,userToInvite,groupConv,function(response){groupConv?$scope.view.replaceUsers($session.conv,response.data.users):convs.addConv(response.data.conv_id,response.data.users,$scope.convs[$session.conv].backend,response.data.messages,[])}),$scope.view.hide("invite"),$scope.view.makeActive($session.conv);var order=contacts.getHighestOrder();contacts.contacts[userToInvite.id].order=order},$interval(function(){""===title.getTitle()?$("title").text(title.getDefaultTitle()):$scope.isWindowActive===!1&&$("title").text(title.getTitle())},1e3),$interval(function(){$("title").text(title.getDefaultTitle())},2e3),window.onfocus=function(){title.updateTitle(""),title.emptyNewMsgs(),$scope.isWindowActive=!0},window.onblur=function(){$scope.isWindowActive=!1},$scope.addEmoji=function(name){var element=$("#chat-msg-input-field");element.focus();var selection=element.getSelection(),textBefore=$scope.fields.chatMsg.substr(0,selection.start),textAfter=$scope.fields.chatMsg.substr(selection.end);$scope.fields.chatMsg=textBefore+" "+name+" "+textAfter+" ",$scope.view.hide("emojiContainer")},$scope.emojis=Chat.app.util.emojis,$scope.$watch("convs[active.conv].msgs",function(){setTimeout(function(){$("#chat-window-msgs").scrollTop($("#chat-window-msgs")[0].scrollHeight)},250)},!0),$scope.contactInRoster=function(id){return backends.xmpp.handle.contactInRoster(id)},$scope.contactInContacts=function(convId){var contact=contacts.findByBackendValue("xmpp",convId);return contact.saved},init()}]),angular.module("chat").controller("SettingsController",["$scope","$interval","backends","session","$http",function($scope,initvar,backends,$session,$http){Chat.settings=$scope,$scope.backends=backends,$scope.status=null,$scope.save=function(){$scope.status="saving",$http.post(OC.generateUrl("/apps/chat/config/set"),{backends:$scope.backends}).success(function(){$scope.status="saved";for(var key in backends){var backend=backends[key];backend.handle.configChanged()}}).error(function(){$scope.status="error"})}}]),angular.module("chat").directive("autoCenter",[function(){function center(element){var windowHeight=$(window).height(),windowWidth=$(window).width(),elementHeight=element.height(),elementWidth=element.width(),left=(windowWidth-elementWidth)/2,top=(windowHeight-elementHeight)/2;element.css("left",left),element.css("top",top)}return{restrict:"A",link:function($scope,element){center(element),$(window).resize(function(){console.log("resize"),center(element)})}}}]),angular.module("chat").directive("autoHeight",[function(){return{restrict:"A",link:function($scope,element,attrs){attrs.convId===$scope.$session.conv?attrs.itemCount++:element.css("height",attrs.minHeight+"px");var height=attrs.itemCount*attrs.itemHeight;height<attrs.minHeight?element.css("height",attrs.minHeight+"px"):element.css("height",height+"px"),$scope.$watch("$session.conv",function(){if(attrs.convId===$scope.$session.conv){var height=attrs.itemCount*attrs.itemHeight;attrs.itemCount>1&&(height+=30),height<attrs.minHeight?element.css("height",attrs.minHeight+"px"):element.css("height",height+"px")}else element.css("height",attrs.minHeight+"px")})}}}]),angular.module("chat").directive("avatar",["contacts",function(contacts){return{restrict:"A",link:function($scope,element,attrs){element.applyContactAvatar(attrs.addressbookBackend,attrs.addressbookId,attrs.id,attrs.displayname,attrs.size),void 0!==attrs.online&&(element.online(attrs.isonline),$scope.$watch("contacts",function(){element.online(contacts.contacts[attrs.id].online)},!0))}}}]),angular.module("chat").directive("displayname",function(){return{restrict:"A",link:function($scope,element,attrs){var text="";users="string"==typeof attrs.users?JSON.parse(attrs.users):attrs.users;for(var key in users){var user=users[key];user.id!==OC.currentUser&&(text+=user.displayname+" ")}element.text(text)}}}),angular.module("chat").directive("inviteMobile",function(){return{restrict:"A",link:function($scope,element){$(window).width()<768&&element.addClass("invite-container-mobile")}}}),angular.module("chat").directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&event.shiftKey===!1&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),angular.module("chat").directive("time",function(){return{restrict:"A",link:function($scope,element,attrs){var time=moment.unix(parseInt(attrs.timestamp)).format("h:mm");element.text(time)}}}),angular.module("chat").directive("tipsy",function(){return{restrict:"A",link:function($scope,element){element.tipsy()}}}),angular.module("chat").directive("xmppAuthorize",["authorize",function(authorize){return{restrict:"E",link:function($scope){$scope.authorize=authorize}}}]),angular.module("chat").factory("authorize",[function(){return{show:!1,name:null,jid:null,approve:null,deny:null}}]),angular.module("chat").factory("backends",["initvar","$injector",function(initvar,$injector){var backends=initvar.backends,result={};for(var id in backends)result[id]=backends[id],result[id].handle=$injector.get(id);return result}]),angular.module("chat").factory("contacts",["$filter","initvar","$http",function($filter,initvar,$http){return{contacts:initvar.contactsObj,getHighestOrder:function(){var sortedContacts=$filter("orderObjectBy")(this.contacts,"order");return sortedContacts[sortedContacts.length-1].order+1},markOnline:function(id){this.contacts[id].online=!0},markOffline:function(id){this.contacts[id].online=!1},findByBackendValue:function(backendId,value){for(var key in this.contacts){var contact=this.contacts[key];for(var backendKey in contact.backends){var backend=contact.backends[backendKey];if(backend.id===backendId&&backend.value===value)return console.log("contact "+key),this.contacts[key]}}return!1},findByBackend:function(backendId){var result=[];for(var key in this.contacts){var contact=this.contacts[key];for(var backendKey in contact.backends){var backend=contact.backends[backendKey];backend.id===backendId&&(result[key]=contact)}}return result},addContacts:function(contacts,success){$this=this,$http.post(OC.generateUrl("/apps/chat/contacts/add/"),{contacts:contacts}).success(function(data){$.extend($this.contacts,data),success()}).error(function(){})},removeContacts:function(contacts){$this=this,$http.post(OC.generateUrl("/apps/chat/contacts/remove/"),{contacts:contacts}).success(function(){alert("done")}).error(function(){})},self:function(){return this.contacts[OC.currentUser]}}}]),angular.module("chat").factory("convs",["contacts","$filter","title","session","$injector",function(contacts,$filter,title,$session,$injector){var convs={};return{convs:convs,get:function(id){return convs[id]},addConv:function(id,users,backend,msgs,files){var name="";for(var key in users){var user=users[key];if(user.id!==$session.user.id){name+=user.displayname+" ";var order=contacts.getHighestOrder()}}if("string"==typeof backend){var backends=$injector.get("backends");backend=backends[backend]}if(void 0===convs[id]){var order=this.getHighestOrder();if(convs[id]={id:id,users:users,msgs:[],backend:backend,new_msg:!1,raw_msgs:[],order:order,name:name,files:files},this.makeActive(id),void 0!==msgs)for(var key in msgs){var msg=msgs[key];this.addChatMsg(id,contacts[msg.user],msg.msg,msg.timestamp,backend)}}},getHighestOrder:function(){var sortedConvs=$filter("orderObjectBy")(convs,"order");return void 0!==sortedConvs[sortedConvs.length-1]?sortedConvs[sortedConvs.length-1].order+1:1},addChatMsg:function(convId,user,msg,timestamp,backend,noNotify){void 0===noNotify&&(noNotify=!1),user.id!==$session.user.id&&noNotify===!1&&title.notify(user.displayname),convId!==$session.conv&&noNotify===!1&&this.notifyMsgInConv(convId);var contact=user;convs[convId].msgs.push({contact:contact,msg:$.trim(msg),timestamp:timestamp,time:Chat.app.util.timeStampToDate(timestamp)}),convs[convId].raw_msgs.push({msg:msg,timestamp:timestamp,user:user}),convs[convId].order=this.getHighestOrder()+1},replaceUsers:function(convId,users){convs[convId].users=users},notifyMsgInConv:function(convId){convs[convId].new_msg=!0},addUserToConv:function(convId,user){-1===convs[convId].users.indexOf(user)&&convs[convId].users.push(user)},getFirstConv:function(){for(var firstConv in convs)break;return"undefined"!=typeof firstConv?firstConv:void 0},makeActive:function(convId,$event,exception){$scope=$("#app").scope(),$scope.$$phase?$scope.view.makeActive(convId,$event,exception):$scope.$apply(function(){$scope.view.makeActive(convId,$event,exception)})},attachFile:function(convId,path,timestamp,user){void 0===timestamp&&(timestamp=Time.now()),convs[convId].files.push({path:path,user:user,timestamp:timestamp}),this.addChatMsg(convId,user,tran("translations-attached",{displayname:user.displayname,path:path}),timestamp,"och")},removeFile:function(convId,path,timestamp,user,key){convs[convId].files.splice(key,1),this.addChatMsg(convId,user,tran("translations-removed",{displayname:user.displayname,path:path}),timestamp,"och")},exists:function(convId){return"undefined"==typeof convs[convId]?!1:!0}}}]),angular.module("chat").factory("initvar",[function(){var initvar=JSON.parse($("#initvar").text());return $("#initvar").text(""),initvar}]),angular.module("chat").factory("title",[function(){var title,default_title="Chat - ownCloud",new_msgs=[];return{updateTitle:function(newTitle){title=newTitle},getDefaultTitle:function(){return default_title},getTitle:function(){return title},notify:function(user){-1==new_msgs.indexOf(user)&&new_msgs.push(user);var newTitle="New messages from ";if(0===new_msgs.length)newTitle="";else for(var key in new_msgs){var user=new_msgs[key];newTitle=newTitle+user+" "}this.updateTitle(newTitle)},emptyNewMsgs:function(){new_msgs=[],this.updateTitle("")}}}]),angular.module("chat").filter("count",function(){return function(items){var count=0;for(var key in items)count++;return count}}),angular.module("chat").filter("emoji",function(){return function(input){return emojione.toImage(input)}}),angular.module("chat").filter("enhanceFiles",[function(){return function(text){var imgRegex=/(\S*\.(?:gif|jpg|jpeg|tiff|png|svg|webp))/gi,img='<a href="/index.php/apps/files/ajax/download.php?dir=/&files=$1"><img alt="image" height="150px" src="/index.php/apps/files/ajax/download.php?dir=/&files=$1"/></a>';return text=text.replace(imgRegex,img)}}]),angular.module("chat").filter("filterUsersInConv",["convs","session",function(convs,$session){return function(contacts){var result=[],users=convs.get($session.conv).users,usersId=[];for(var key in users){var user=users[key];usersId.push(user.id)}for(var key in contacts){var contact=contacts[key];-1===$.inArray(contact.id,usersId)&&result.push(contact)}return result}}]),angular.module("chat").filter("orderObjectBy",function(){return function(items,field,reverse){var filtered=[];for(var key in items){var item=items[key];filtered.push(item)}return filtered.sort(function(a,b){return a[field]>b[field]?1:-1}),reverse&&filtered.reverse(),filtered}}),angular.module("chat").filter("toEmojiArray",function(){return function(items){var array=[];for(var key in items)if(items.hasOwnProperty(key)){var item=items[key];array.push(2===item.length?{key:key,value:item[1]}:{key:key,value:item[0]})}return array}}),angular.module("chat").filter("userFilter",function(){return function(users){var output=[];for(var key in users){var user=users[key];user.id!==OC.currentUser&&output.push(user)}return output}}),angular.module("chat").value("session",{id:null,conv:null,user:{}}),function($){$.fn.online=function(isonline){var $div=this;"true"===isonline||isonline===!0?$div.next().addClass("online-dot"):$div.next().removeClass("online-dot")}}(jQuery),!function($){$.fn.applyContactAvatar=function(addressbookBackend,addressBookId,id,displayname,size){var $div=this,cacheTime=Cache.day(1);$div.height(size),$div.width(size);var cacheId=id,value=Cache.get(cacheId);if(void 0!==value)if(1==value.noAvatar)$div.imageplaceholder(displayname);else{var url=value.base64+"?requesttoken="+oc_requesttoken;$div.show(),$div.html('<img width="'+size+'" height="'+size+'" src="'+url+'">')}else{var url=OC.generateUrl("/avatar/{user}/{size}?requesttoken={requesttoken}",{user:id,size:size*window.devicePixelRatio,requesttoken:oc_requesttoken});$.get(url,function(result){if("object"==typeof result)Cache.set(cacheId,{noAvatar:!0},cacheTime),$div.imageplaceholder(displayname);else{var cacheUrl=OC.generateUrl("/avatar/{user}/{size}",{user:id,size:size*window.devicePixelRatio});Cache.set(cacheId,{noAvatar:!1,base64:cacheUrl},cacheTime),$div.show(),$div.html('<img width="'+size+'" height="'+size+'" src="'+url+'">')}})}}}(jQuery);var Cache=function(){function time(){return parseInt((new Date).getTime()/1e3)}function init(){cache.storage=supportLocalstorage?{set:function(key,value){value=JSON.stringify(value),localStorage[key]=value},get:function(key){var value=localStorage[key];return void 0!==value?JSON.parse(value):void 0},remove:function(key){localStorage.removeItem(key)}}:{set:function(key,value){this[key]=value},get:function(key){return this[key]},remove:function(key){delete this[key]}}}function supportLocalstorage(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}var cache={};return cache.initialized=!1,cache.set=function(key,value,expire){if(void 0===expire)var date=0;else var date=time()+expire;key="cache"+key,cache.storage.set(key,{key:key,value:value,expire:date})},cache.get=function(key){var value=cache.storage.get("cache"+key);return void 0!==value?0===value.expire?value.value:value.expire-time()<=0?void cache.storage.remove("cache"+key):value.value:void 0},cache.day=function(count){return 86400*count},cache.hour=function(count){return 3600*count},cache.minute=function(count){return 60*count},cache.initialized||init(),cache}(),Time=function(){var time={};return time.now=function(){return parseInt((new Date).getTime()/1e3)},time}();