/*! owncloud-chat 2014-09-21 */
angular.module("chat",["ngSanitize","bernhardposselt.enhancetext"]),angular.module("chat").config(["enhanceTextFilterProvider",function(enhanceTextFilterProvider){enhanceTextFilterProvider.setOptions({embeddedImagesHeight:"150px",smilies:{":+1:":OC.imagePath("chat","/emoji/+1.png"),":-1:":OC.imagePath("chat","/emoji/-1.png"),":alien:":OC.imagePath("chat","/emoji/alien.png"),":angry:":OC.imagePath("chat","/emoji/angry.png"),":anguished:":OC.imagePath("chat","/emoji/anguished.png"),":astonished:":OC.imagePath("chat","/emoji/astonished.png"),":blush:":OC.imagePath("chat","/emoji/blush.png"),":bowtie:":OC.imagePath("chat","/emoji/bowtie.png"),":clap:":OC.imagePath("chat","/emoji/clap.png"),":cold_sweat:":OC.imagePath("chat","/emoji/cold_sweat.png"),":confounded:":OC.imagePath("chat","/emoji/confounded.png"),":confused:":OC.imagePath("chat","/emoji/confused.png"),":cry:":OC.imagePath("chat","/emoji/cry.png"),":disappointed:":OC.imagePath("chat","/emoji/disappointed.png"),":disappointed_relieved:":OC.imagePath("chat","/emoji/disappointed_relieved.png"),":dizzy_face:":OC.imagePath("chat","/emoji/dizzy_face.png"),":expressionless:":OC.imagePath("chat","/emoji/expressionless.png"),":facepunch:":OC.imagePath("chat","/emoji/facepunch.png"),":fearful:":OC.imagePath("chat","/emoji/fearful.png"),":fist:":OC.imagePath("chat","/emoji/fist.png"),":flushed:":OC.imagePath("chat","/emoji/flushed.png"),":frowning:":OC.imagePath("chat","/emoji/frowning.png"),":grimacing:":OC.imagePath("chat","/emoji/grimacing.png"),":grin:":OC.imagePath("chat","/emoji/grin.png"),":grinning:":OC.imagePath("chat","/emoji/grinning.png"),":hand:":OC.imagePath("chat","/emoji/hand.png"),":heart_eyes:":OC.imagePath("chat","/emoji/heart_eyes.png"),":hushed:":OC.imagePath("chat","/emoji/hushed.png"),":imp:":OC.imagePath("chat","/emoji/imp.png"),":innocent:":OC.imagePath("chat","/emoji/innocent.png"),":joy:":OC.imagePath("chat","/emoji/joy.png"),":kissing:":OC.imagePath("chat","/emoji/kissing.png"),":kissing_closed_eyes:":OC.imagePath("chat","/emoji/kissing_closed_eyes.png"),":kissing_heart:":OC.imagePath("chat","/emoji/kissing_heart.png"),":kissing_smiling_eyes:":OC.imagePath("chat","/emoji/kissing_smiling_eyes.png"),":laughing:":OC.imagePath("chat","/emoji/laughing.png"),":mask:":OC.imagePath("chat","/emoji/mask.png"),":neckbeard:":OC.imagePath("chat","/emoji/neckbeard.png"),":neutral_face:":OC.imagePath("chat","/emoji/neutral_face.png"),":no_mouth:":OC.imagePath("chat","/emoji/no_mouth.png"),":ok_hand:":OC.imagePath("chat","/emoji/ok_hand.png"),":open_hands:":OC.imagePath("chat","/emoji/open_hands.png"),":open_mouth:":OC.imagePath("chat","/emoji/open_mouth.png"),":pensive:":OC.imagePath("chat","/emoji/pensive.png"),":persevere:":OC.imagePath("chat","/emoji/persevere.png"),":point_down:":OC.imagePath("chat","/emoji/point_down.png"),":point_left:":OC.imagePath("chat","/emoji/point_left.png"),":point_right:":OC.imagePath("chat","/emoji/point_right.png"),":point_up:":OC.imagePath("chat","/emoji/point_up.png"),":point_up_2:":OC.imagePath("chat","/emoji/point_up_2.png"),":pray:":OC.imagePath("chat","/emoji/pray.png"),":punch:":OC.imagePath("chat","/emoji/punch.png"),":rage:":OC.imagePath("chat","/emoji/rage.png"),":raised_hand:":OC.imagePath("chat","/emoji/raised_hand.png"),":raised_hands:":OC.imagePath("chat","/emoji/raised_hands.png"),":relaxed:":OC.imagePath("chat","/emoji/relaxed.png"),":relieved:":OC.imagePath("chat","/emoji/relieved.png"),":satisfied:":OC.imagePath("chat","/emoji/satisfied.png"),":scream:":OC.imagePath("chat","/emoji/scream.png"),":sleeping:":OC.imagePath("chat","/emoji/sleeping.png"),":sleepy:":OC.imagePath("chat","/emoji/sleepy.png"),":smile:":OC.imagePath("chat","/emoji/smile.png"),":smiley:":OC.imagePath("chat","/emoji/smiley.png"),":smiling_imp:":OC.imagePath("chat","/emoji/smiling_imp.png"),":smirk:":OC.imagePath("chat","/emoji/smirk.png"),":sob:":OC.imagePath("chat","/emoji/sob.png"),":stuck_out_tongue:":OC.imagePath("chat","/emoji/stuck_out_tongue.png"),":stuck_out_tongue_closed_eyes:":OC.imagePath("chat","/emoji/stuck_out_tongue_closed_eyes.png"),":stuck_out_tongue_winking_eye:":OC.imagePath("chat","/emoji/stuck_out_tongue_winking_eye.png"),":sunglasses:":OC.imagePath("chat","/emoji/sunglasses.png"),":sweat:":OC.imagePath("chat","/emoji/sweat.png"),":sweat_smile:":OC.imagePath("chat","/emoji/sweat_smile.png"),":thumbsdown:":OC.imagePath("chat","/emoji/thumbsdown.png"),":thumbsup:":OC.imagePath("chat","/emoji/thumbsup.png"),":tired_face:":OC.imagePath("chat","/emoji/tired_face.png"),":triumph:":OC.imagePath("chat","/emoji/triumph.png"),":unamused:":OC.imagePath("chat","/emoji/unamused.png"),":v:":OC.imagePath("chat","/emoji/v.png"),":wave:":OC.imagePath("chat","/emoji/wave.png"),":weary:":OC.imagePath("chat","/emoji/weary.png"),":wink:":OC.imagePath("chat","/emoji/wink.png"),":worried:":OC.imagePath("chat","/emoji/worried.png"),":yum:":OC.imagePath("chat","/emoji/yum.png")}})}]),window.Chat=window.Chat||{},Chat.app=Chat.app||{},Chat.app.util={timeStampToDate:function(timestamp){{var date=new Date(1e3*timestamp);date.getHours(),(date.getMinutes()<10?"0":"")+date.getMinutes(),date.getSeconds()}return{hours:date.getHours(),minutes:(date.getMinutes()<10?"0":"")+date.getMinutes(),seconds:date.getSeconds()}},isYoutubeUrl:function(url){return url.indexOf("https://youtube.com")>-1||url.indexOf("https://youtube.com")>-1||url.indexOf("https://www.youtube.com")>-1||url.indexOf("http://www.youtube.com")>-1||url.indexOf("http://youtu.be")>-1?!0:!1},isImageUrl:function(url){var imgRegex=/((?:https?):\/\/\S*\.(?:gif|jpg|jpeg|tiff|png|svg|webp))/gi;return imgRegex.test(url)},emojis:[{name:":+1:",url:OC.imagePath("chat","emoji/+1.png")},{name:":-1:",url:OC.imagePath("chat","emoji/-1.png")},{name:":alien:",url:OC.imagePath("chat","emoji/alien.png")},{name:":angry:",url:OC.imagePath("chat","emoji/angry.png")},{name:":anguished:",url:OC.imagePath("chat","emoji/anguished.png")},{name:":astonished:",url:OC.imagePath("chat","emoji/astonished.png")},{name:":blush:",url:OC.imagePath("chat","emoji/blush.png")},{name:":bowtie:",url:OC.imagePath("chat","emoji/bowtie.png")},{name:":clap:",url:OC.imagePath("chat","emoji/clap.png")},{name:":cold_sweat:",url:OC.imagePath("chat","emoji/cold_sweat.png")},{name:":confounded:",url:OC.imagePath("chat","emoji/confounded.png")},{name:":confused:",url:OC.imagePath("chat","emoji/confused.png")},{name:":cry:",url:OC.imagePath("chat","emoji/cry.png")},{name:":disappointed:",url:OC.imagePath("chat","emoji/disappointed.png")},{name:":disappointed_relieved:",url:OC.imagePath("chat","emoji/disappointed_relieved.png")},{name:":dizzy_face:",url:OC.imagePath("chat","emoji/dizzy_face.png")},{name:":expressionless:",url:OC.imagePath("chat","emoji/expressionless.png")},{name:":facepunch:",url:OC.imagePath("chat","emoji/facepunch.png")},{name:":fearful:",url:OC.imagePath("chat","emoji/fearful.png")},{name:":fist:",url:OC.imagePath("chat","emoji/fist.png")},{name:":flushed:",url:OC.imagePath("chat","emoji/flushed.png")},{name:":frowning:",url:OC.imagePath("chat","emoji/frowning.png")},{name:":grimacing:",url:OC.imagePath("chat","emoji/grimacing.png")},{name:":grin:",url:OC.imagePath("chat","emoji/grin.png")},{name:":grinning:",url:OC.imagePath("chat","emoji/grinning.png")},{name:":hand:",url:OC.imagePath("chat","emoji/hand.png")},{name:":heart_eyes:",url:OC.imagePath("chat","emoji/heart_eyes.png")},{name:":hushed:",url:OC.imagePath("chat","emoji/hushed.png")},{name:":imp:",url:OC.imagePath("chat","emoji/imp.png")},{name:":innocent:",url:OC.imagePath("chat","emoji/innocent.png")},{name:":joy:",url:OC.imagePath("chat","emoji/joy.png")},{name:":kissing:",url:OC.imagePath("chat","emoji/kissing.png")},{name:":kissing_closed_eyes:",url:OC.imagePath("chat","emoji/kissing_closed_eyes.png")},{name:":kissing_heart:",url:OC.imagePath("chat","emoji/kissing_heart.png")},{name:":kissing_smiling_eyes:",url:OC.imagePath("chat","emoji/kissing_smiling_eyes.png")},{name:":laughing:",url:OC.imagePath("chat","emoji/laughing.png")},{name:":mask:",url:OC.imagePath("chat","emoji/mask.png")},{name:":neckbeard:",url:OC.imagePath("chat","emoji/neckbeard.png")},{name:":neutral_face:",url:OC.imagePath("chat","emoji/neutral_face.png")},{name:":no_mouth:",url:OC.imagePath("chat","emoji/no_mouth.png")},{name:":ok_hand:",url:OC.imagePath("chat","emoji/ok_hand.png")},{name:":open_hands:",url:OC.imagePath("chat","emoji/open_hands.png")},{name:":open_mouth:",url:OC.imagePath("chat","emoji/open_mouth.png")},{name:":pensive:",url:OC.imagePath("chat","emoji/pensive.png")},{name:":persevere:",url:OC.imagePath("chat","emoji/persevere.png")},{name:":point_down:",url:OC.imagePath("chat","emoji/point_down.png")},{name:":point_left:",url:OC.imagePath("chat","emoji/point_left.png")},{name:":point_right:",url:OC.imagePath("chat","emoji/point_right.png")},{name:":point_up:",url:OC.imagePath("chat","emoji/point_up.png")},{name:":point_up_2:",url:OC.imagePath("chat","emoji/point_up_2.png")},{name:":pray:",url:OC.imagePath("chat","emoji/pray.png")},{name:":punch:",url:OC.imagePath("chat","emoji/punch.png")},{name:":rage:",url:OC.imagePath("chat","emoji/rage.png")},{name:":raised_hand:",url:OC.imagePath("chat","emoji/raised_hand.png")},{name:":raised_hands:",url:OC.imagePath("chat","emoji/raised_hands.png")},{name:":relaxed:",url:OC.imagePath("chat","emoji/relaxed.png")},{name:":relieved:",url:OC.imagePath("chat","emoji/relieved.png")},{name:":satisfied:",url:OC.imagePath("chat","emoji/satisfied.png")},{name:":scream:",url:OC.imagePath("chat","emoji/scream.png")},{name:":sleeping:",url:OC.imagePath("chat","emoji/sleeping.png")},{name:":sleepy:",url:OC.imagePath("chat","emoji/sleepy.png")},{name:":smile:",url:OC.imagePath("chat","emoji/smile.png")},{name:":smiley:",url:OC.imagePath("chat","emoji/smiley.png")},{name:":smiling_imp:",url:OC.imagePath("chat","emoji/smiling_imp.png")},{name:":smirk:",url:OC.imagePath("chat","emoji/smirk.png")},{name:":sob:",url:OC.imagePath("chat","emoji/sob.png")},{name:":stuck_out_tongue:",url:OC.imagePath("chat","emoji/stuck_out_tongue.png")},{name:":stuck_out_tongue_closed_eyes:",url:OC.imagePath("chat","emoji/stuck_out_tongue_closed_eyes.png")},{name:":stuck_out_tongue_winking_eye:",url:OC.imagePath("chat","emoji/stuck_out_tongue_winking_eye.png")},{name:":sunglasses:",url:OC.imagePath("chat","emoji/sunglasses.png")},{name:":sweat:",url:OC.imagePath("chat","emoji/sweat.png")},{name:":sweat_smile:",url:OC.imagePath("chat","emoji/sweat_smile.png")},{name:":thumbsdown:",url:OC.imagePath("chat","emoji/thumbsdown.png")},{name:":thumbsup:",url:OC.imagePath("chat","emoji/thumbsup.png")},{name:":tired_face:",url:OC.imagePath("chat","emoji/tired_face.png")},{name:":triumph:",url:OC.imagePath("chat","emoji/triumph.png")},{name:":unamused:",url:OC.imagePath("chat","emoji/unamused.png")},{name:":v:",url:OC.imagePath("chat","emoji/v.png")},{name:":wave:",url:OC.imagePath("chat","emoji/wave.png")},{name:":weary:",url:OC.imagePath("chat","emoji/weary.png")},{name:":wink:",url:OC.imagePath("chat","emoji/wink.png")},{name:":worried:",url:OC.imagePath("chat","emoji/worried.png")},{name:":yum:",url:OC.imagePath("chat","emoji/yum.png")}]},window.Chat=window.Chat||{},Chat.app=Chat.app||{},Chat.app.view={addConv:function(convId,users,backend,msgs){Chat.scope.$apply(function(){Chat.scope.view.addConv(convId,users,backend,msgs)})},addChatMsg:function(convId,contact,msg,timestamp,backend,noNotify){Chat.scope.$apply(function(){Chat.scope.view.addChatMsg(convId,contact,msg,timestamp,backend,noNotify)})},addUserToConv:function(convId,user){Chat.scope.$apply(function(){Chat.scope.view.addUserToConv(convId,user)})},getBackends:function(key){var returnBackend;for(var index in Chat.scope.backends){var backend=Chat.scope.backends[index];key===backend.name&&(returnBackend=backend)}return returnBackend},replaceUsers:function(convId,users){Chat.scope.$apply(function(){Chat.scope.view.replaceUsers(convId,users)})},makeActive:function(convId,$event,exception){Chat.scope.$apply(function(){Chat.scope.view.makeActive(convId,$event,exception)})},makeUserOnline:function(userId){Chat.scope.$apply(function(){Chat.scope.view.makeUserOnline(userId)})},makeUserOffline:function(userId){Chat.scope.$apply(function(){Chat.scope.view.makeUserOffline(userId)})}},angular.module("chat").controller("ConvController",["$scope","$http","$filter","$interval","initvar","och","convs","activeUser","contacts","backends",function($scope,$http,$filter,$interval,initvar,och,convs,activeUser,contacts,backends){function init(){for(var key in backends)backends[key].handle.init();$scope.initDone=!0;for(var key in $scope.initConvs.och){var conv=$scope.initConvs.och[key],contactsInConv=[];for(var key in conv.users){var user=conv.users[key];contactsInConv.push(contacts.contacts[user])}convs.addConv(conv.id,contactsInConv,backends.och,[]);for(var key in conv.messages){var msg=conv.messages[key];convs.addChatMsg(conv.id,contacts.contacts[msg.user],msg.msg,msg.timestamp,backends.och,!0)}}}Chat.scope=$scope,$scope.view={elements:{emptyMsg:!0,chat:!1,initDone:!1,settings:!1,emojiContainer:!1,invite:!1},inviteClick:function(){$scope.view.toggle("invite"),setTimeout(function(){$("#invite-search-field").focus()},1)},showEmojiPopover:function(){var height=$("#chat-window-footer").height();$scope.view.toggle("emojiContainer"),setTimeout(function(){$("#emoji-container").css("bottom",height+20)},1),console.log(height)},show:function(element,$event,exception){if(void 0!==$event){var classList=$event.target.classList;if(classList.contains(exception))return}$scope.view.elements[element]=!0},hide:function(element,$event,exceptions){if(void 0!==$event)for(var classList=$event.target.classList,i=0;i<exceptions.length;i++)if(classList.contains(exceptions[i]))return;$scope.view.elements[element]=!1},toggle:function(element){$scope.view.elements[element]=!$scope.view.elements[element]},updateTitle:function(newTitle){$scope.title=newTitle},makeActive:function(convId,$event,exception){$scope.view.hide("emptyMsg"),$scope.view.show("chat",$event,exception),$scope.active.conv=convId,$scope.view.focusMsgInput(),convs.get(convId).new_msg=!1,$("#chat-msg-input-field").autosize({callback:function(){var height=$("#chat-msg-input-field").height();height+=15,$("#chat-window-footer").height(height),$("#chat-window-body").css("bottom",height),$("#chat-window-msgs").scrollTop($("#chat-window-msgs")[0].scrollHeight);var height=$("#chat-window-footer").height();$("#emoji-container").css("bottom",height+20)}})},unActive:function(){$scope.active.conv=null},focusMsgInput:function(){$("#chat-msg-input-field")}},$scope.sendChatMsg=function(){if(""!==$scope.fields.chatMsg){var backend=$scope.convs[$scope.active.conv].backend.name;convs.addChatMsg($scope.active.conv,$scope.active.user,$scope.fields.chatMsg,Time.now(),backend),backends[backend].handle.sendChatMsg($scope.active.conv,$scope.fields.chatMsg),$scope.fields.chatMsg="";var order=contacts.getHighestOrder();setTimeout(function(){$("#chat-msg-input-field").trigger("autosize.resize")},1),$("#chat-msg-input-field").focus();for(var key in $scope.convs[$scope.active.conv].users){var user=$scope.convs[$scope.active.conv].users[key];if(user.id!==$scope.active.user.id){var order=contacts.getHighestOrder();contacts.contacts[user.id].order=order}}}},$scope.convs=convs.convs,$scope.initConvs={},$scope.active={backend:{},conv:{},window:!0},$scope.title={},$scope.title.title="",$scope.title.default="Chat - ownCloud",$scope.title.new_msgs=[],$scope.fields={chatMsg:""},$scope.active.user=activeUser,$scope.initConvs=initvar.initConvs,$scope.initvar=initvar;for(var active in backends)break;$scope.active.backend=backends[active],$scope.quit=function(){for(var namespace in backends){{backends[namespace]}"och"===namespace&&backends[namespace].handle.quit()}},$scope.makeFirstConvActive=function(){firstConv=$scope.getFirstConv(),void 0===firstConv?($scope.active.conv=null,$scope.view.hide("chat"),$scope.view.show("emptyMsg")):$scope.view.makeActive(firstConv)},$scope.getFirstConv=function(){for(firstConv in $scope.convs)break;return"undefined"!=typeof firstConv?firstConv:void 0},$scope.invite=function(userToInvite){var backend=$scope.convs[$scope.active.conv].backend.name,groupConv=$scope.convs[$scope.active.conv].users.length>2;backends[backend].handle.invite($scope.active.conv,userToInvite,groupConv,function(response){groupConv?$scope.view.replaceUsers($scope.active.conv,response.data.users):convs.addConv(response.data.conv_id,response.data.users,$scope.convs[$scope.active.conv].backend,response.data.messages)}),$scope.view.hide("invite"),$scope.view.makeActive($scope.active.conv);var order=contacts.getHighestOrder();contacts.contacts[userToInvite.id].order=order},$interval(function(){$("title").text(""===$scope.title.title?$scope.title.default:$scope.title.title)},1e3),$interval(function(){$("title").text($scope.title.default)},2e3),$scope.$watchCollection("title.new_msgs",function(){if($scope.active.window===!1){var title="New messages from ";if(0===$scope.title.new_msgs.length)title="";else for(var key in $scope.title.new_msgs){var user=$scope.title.new_msgs[key];title=title+user+" "}$scope.title.title=title}else $scope.title.tile=""}),$scope.notify=function(user){-1==$scope.title.new_msgs.indexOf(user)&&$scope.title.new_msgs.push(user)},window.onfocus=function(){$scope.title.title="",$scope.title.new_msgs=[],$scope.active.window=!0},window.onblur=function(){$scope.active.window=!1},$scope.addEmoji=function(name){var element=$("#chat-msg-input-field");element.focus();var selection=element.getSelection(),textBefore=$scope.fields.chatMsg.substr(0,selection.start),textAfter=$scope.fields.chatMsg.substr(selection.end);$scope.fields.chatMsg=textBefore+" "+name+" "+textAfter+" ",$scope.view.hide("emojiContainer")},$scope.emojis=Chat.app.util.emojis,$scope.$watch("convs[active.conv].msgs",function(){setTimeout(function(){$("#chat-window-msgs").scrollTop($("#chat-window-msgs")[0].scrollHeight)},250)},!0),init()}]),angular.module("chat").directive("autoHeight",function(){return{restrict:"A",link:function($scope,element,attrs){attrs.convId===$scope.active.conv?attrs.itemCount++:element.css("height",attrs.minHeight+"px");var height=attrs.itemCount*attrs.itemHeight;height<attrs.minHeight?element.css("height",attrs.minHeight+"px"):element.css("height",height+"px"),$scope.$watch("active.conv",function(){if(attrs.convId===$scope.active.conv){var height=attrs.itemCount*attrs.itemHeight;attrs.itemCount>1&&(height+=30),height<attrs.minHeight?element.css("height",attrs.minHeight+"px"):element.css("height",height+"px")}else element.css("height",attrs.minHeight+"px")})}}}),angular.module("chat").directive("avatar",["contacts",function(contacts){return{restrict:"A",link:function($scope,element,attrs){element.applyContactAvatar(attrs.addressbookBackend,attrs.addressbookId,attrs.id,attrs.displayname,attrs.size),void 0!==attrs.online&&(element.online(attrs.isonline),$scope.$watch("contactsObj",function(){element.online(contacts.contacts[attrs.id].online)},!0))}}}]),angular.module("chat").directive("displayname",function(){return{restrict:"A",link:function($scope,element,attrs){var text="";users="string"==typeof attrs.users?JSON.parse(attrs.users):attrs.users;for(var key in users){var user=users[key];user.id!==Chat.scope.active.user.id&&(text+=user.displayname+" ")}element.text(text)}}}),angular.module("chat").directive("inviteMobile",function(){return{restrict:"A",link:function($scope,element){$(window).width()<768&&element.addClass("invite-container-mobile")}}}),angular.module("chat").directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&event.shiftKey===!1&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),angular.module("chat").directive("tipsy",function(){return{restrict:"A",link:function($scope,element){element.tipsy()}}}),angular.module("chat").factory("activeUser",["initvar",function(initvar){return initvar.contactsObj[OC.currentUser]}]),angular.module("chat").factory("backends",["initvar","och",function(initvar,och){var backends=initvar.backends;return backends.och.handle=och,backends}]),angular.module("chat").factory("contacts",["$filter","initvar",function($filter,initvar){return{contacts:initvar.contactsObj,getHighestOrder:function(){var sortedContacts=$filter("orderObjectBy")(this.contacts,"order");return sortedContacts[sortedContacts.length-1].order+1},markOnline:function(id){this.contacts[id].online=!0},markOffline:function(){this.contacts[id].online=!1}}}]),angular.module("chat").factory("convs",["activeUser","contacts","$filter",function(activeUser,contacts,$filter){var convs={};return{convs:convs,get:function(id){return convs[id]},addConv:function(id,users,backend,msgs){var name="";for(var key in users){var user=users[key];if(user.id!==activeUser.id){name+=user.displayname+" ";var order=contacts.getHighestOrder()}}if(void 0===convs[id]){var order=this.getHighestOrder();if(convs[id]={id:id,users:users,msgs:[],backend:backend,new_msg:!1,raw_msgs:[],order:order,name:name},void 0!==msgs)for(var key in msgs){var msg=msgs[key];this.addChatMsg(id,contacts[msg.user],msg.msg,msg.timestamp,backend)}}},getHighestOrder:function(){var sortedConvs=$filter("orderObjectBy")(convs,"order");return void 0!==sortedConvs[sortedConvs.length-1]?sortedConvs[sortedConvs.length-1].order+1:1},addChatMsg:function(convId,user,msg,timestamp){var contact=user;if(void 0!==convs[convId].msgs[convs[convId].msgs.length-1]){var lastMsg=convs[convId].msgs[convs[convId].msgs.length-1];lastMsg.contact.displayname===contact.displayname?Chat.app.util.isYoutubeUrl(lastMsg.msg)||Chat.app.util.isImageUrl(lastMsg.msg)?convs[convId].msgs.push(Chat.app.util.timeStampToDate(lastMsg.timestamp).minutes===Chat.app.util.timeStampToDate(timestamp).minutes&&Chat.app.util.timeStampToDate(lastMsg.timestamp).hours===Chat.app.util.timeStampToDate(timestamp).hours?{contact:contact,msg:$.trim(msg),timestamp:timestamp,time:null}:{contact:contact,msg:$.trim(msg),timestamp:timestamp,time:Chat.app.util.timeStampToDate(timestamp)}):(lastMsg.msg=lastMsg.msg+"\n"+msg,convs[convId].msgs[convs[convId].msgs.length-1]=lastMsg):convs[convId].msgs.push(Chat.app.util.timeStampToDate(lastMsg.timestamp).minutes===Chat.app.util.timeStampToDate(timestamp).minutes&&Chat.app.util.timeStampToDate(lastMsg.timestamp).hours===Chat.app.util.timeStampToDate(timestamp).hours?{contact:contact,msg:$.trim(msg),timestamp:timestamp,time:null}:{contact:contact,msg:$.trim(msg),timestamp:timestamp,time:Chat.app.util.timeStampToDate(timestamp)})}else convs[convId].msgs.push({contact:contact,msg:$.trim(msg),timestamp:timestamp,time:Chat.app.util.timeStampToDate(timestamp)});convs[convId].raw_msgs.push({msg:msg,timestamp:timestamp,user:user}),convs[convId].order=this.getHighestOrder()+1},replaceUsers:function(convId,users){convs[convId].users=users},notifyMsgInConv:function(convId){convs[convId].new_msg=!0},addUserToConv:function(convId,user){-1===convs[convId].users.indexOf(user)&&convs[convId].users.push(user)}}}]),angular.module("chat").factory("initvar",[function(){var initvar=JSON.parse($("#initvar").text());return $("#initvar").text(""),initvar}]),angular.module("chat").factory("och",["activeUser","convs","contacts","sessionId",function(activeUser,convs,contacts,sessionId){var api={command:{join:function(convId,success){api.util.doRequest({type:"command::join::request",data:{conv_id:convId,timestamp:Time.now(),user:activeUser,session_id:sessionId}},success)},invite:function(userToInvite,convId,success){api.util.doRequest({type:"command::invite::request",data:{conv_id:convId,timestamp:Time.now(),user_to_invite:userToInvite,user:activeUser,session_id:sessionId}},success)},sendChatMsg:function(msg,convId,success){api.util.doRequest({type:"command::send_chat_msg::request",data:{conv_id:convId,chat_msg:msg,user:activeUser,session_id:sessionId,timestamp:Time.now()}},success)},online:function(){api.util.doRequest({type:"command::online::request",data:{user:activeUser,session_id:sessionId,timestamp:Time.now()}},function(){})},offline:function(){api.util.doSyncRequest({type:"command::offline::request",data:{user:activeUser,session_id:sessionId,timestamp:Time.now()}},function(){})},startConv:function(userToInvite,success){api.util.doRequest({type:"command::start_conv::request",data:{user:activeUser,session_id:sessionId,timestamp:Time.now(),user_to_invite:userToInvite}},success)},getMessages:function(convId,startpoint,success){api.util.doRequest({type:"data::messages::request",data:{user:activeUser,session_id:sessionId,conv_id:convId,startpoint:startpoint}},success)},getUsers:function(convId,success){api.util.doRequest({type:"data::get_users::request",data:{user:activeUser,session_id:sessionId,conv_id:convId}},success)}},on:{invite:function(data){var backend=Chat.app.view.getBackends("och"),convId=data.conv_id;void 0===convs.get(convId)&&api.command.join(data.conv_id,function(dataJoin){var users=dataJoin.data.users,msgs=dataJoin.data.messages;convs.addConv(convId,users,backend,msgs)})},chatMessage:function(data){convs.addChatMsg(data.conv_id,data.user,data.chat_msg,data.timestamp,"och")},joined:function(data){convs.replaceUsers(data.conv_id,data.users)},online:function(data){contacts.markOnline(data.user.id)},offline:function(data){contacts.markOffline(data.user.id)}},util:{doRequest:function(request,success){$.ajax({type:"POST",url:OC.generateUrl("/apps/chat/och/api"),data:JSON.stringify(request),headers:{"Content-Type":"application/json"}}).always(function(data){success(data)})},doSyncRequest:function(request){$.ajax({type:"POST",url:OC.generateUrl("/apps/chat/och/api"),data:JSON.stringify(request),headers:{"Content-Type":"application/json"},async:!0})},longPoll:function(){api.util.getPushMessages(function(data){var ids_del=[];for(var push_id in data.push_msgs){var push_msg=data.push_msgs[push_id];ids_del.push(push_id),api.util.handlePushMessage(push_msg)}api.util.deletePushMessages(ids_del,function(){api.util.longPoll()})})},handlePushMessage:function(push_msg){"invite"===push_msg.type?api.on.invite(push_msg.data):"send_chat_msg"===push_msg.type?api.on.chatMessage(push_msg.data):"joined"===push_msg.type?api.on.joined(push_msg.data):"online"===push_msg.type?api.on.online(push_msg.data):"offline"===push_msg.type&&api.on.offline(push_msg.data)},getPushMessages:function(success){api.util.doRequest({type:"push::get::request",data:{user:activeUser,session_id:sessionId}},success)},deletePushMessages:function(ids,success){api.util.doRequest({type:"push::delete::request",data:{user:activeUser,session_id:sessionId,ids:ids}},function(){success()})}},INVALID_HTTP_TYPE:0,COMMAND_NOT_FOUND:1,PUSH_ACTION_NOT_FOUND:2,DATA_ACTION_NOT_FOUND:3,NO_SESSION_ID:6,USER_NOT_EQUAL_TO_OC_USER:7,NO_TIMESTAMP:8,NO_CONV_ID:9,NO_USER_TO_INVITE:10,USER_EQUAL_TO_USER_TO_INVITE:11,USER_TO_INVITE_NOT_OC_USER:12,NO_CHAT_MSG:13};return{init:function(){api.util.longPoll(),setInterval(api.command.online,6e3)},quit:function(){api.command.offline()},sendChatMsg:function(convId,msg){api.command.sendChatMsg(msg,convId,function(){})},invite:function(convId,userToInvite,groupConv,callback){if(groupConv)api.command.invite(userToInvite,convId,callback);else{var users=[];for(var key in convs.get(convId).users)users.push(convs.get(convId).users[key]);users.push(userToInvite),this.newConv(users,callback)}},newConv:function(userToInvite,success){api.command.startConv(userToInvite,success)}}}]),angular.module("chat").factory("sessionId",["initvar",function(initvar){return initvar.sessionId}]),angular.module("chat").filter("filterUsersInConv",function(){return function(contacts){var result=[],users=Chat.scope.convs[Chat.scope.active.conv].users;return angular.forEach(contacts,function(contact){-1===$.inArray(contact,users)&&result.push(contact)}),result}}),angular.module("chat").filter("orderObjectBy",function(){return function(items,field,reverse){var filtered=[];for(var key in items){var item=items[key];filtered.push(item)}return filtered.sort(function(a,b){return a[field]>b[field]?1:-1}),reverse&&filtered.reverse(),filtered}}),angular.module("chat").filter("userFilter",function(){return function(users){var output=[];for(var key in users){var user=users[key];user.id!==Chat.scope.active.user.id&&output.push(user)}return output}}),$(window).unload(function(){Chat.scope.$apply(function(){Chat.scope.quit()})}),function($){$.fn.online=function(isonline){var $div=this;"true"===isonline||isonline===!0?$div.next().addClass("online-dot"):$div.next().removeClass("online-dot")}}(jQuery);